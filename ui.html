<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Together AI Troubleshooting Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            background: #fafafa;
        }

        .section h2 {
            color: #2a5298;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid #2a5298;
            padding-bottom: 10px;
        }

        .quick-check {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .quick-check h2 {
            color: white;
            border-bottom-color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .quick-check label {
            color: white;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 10px rgba(42, 82, 152, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
        }

        .results {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border-left: 5px solid #2a5298;
        }

        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid;
        }

        .result-pass {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .result-fail {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .result-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .result-info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .status-pass {
            background: #28a745;
            color: white;
        }

        .status-fail {
            background: #dc3545;
            color: white;
        }

        .status-warning {
            background: #ffc107;
            color: #333;
        }

        .status-info {
            background: #17a2b8;
            color: white;
        }

        .error-lookup {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .error-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #dc3545;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .error-card:hover {
            transform: translateY(-5px);
        }

        .error-code {
            font-size: 1.5em;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2a5298;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom-color: #2a5298;
            color: #2a5298;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .diagnostic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .diagnostic-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .diagnostic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card-icon {
            font-size: 2em;
            margin-bottom: 10px;
            color: #2a5298;
        }

        .recommendation {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 8px 8px 0;
        }

        .recommendation-title {
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Together AI Troubleshooting Tool</h1>
            <p>Diagnose and resolve common Together AI inference service issues</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <div class="tab active" onclick="showTab('quick-check')">Quick Check</div>
                <div class="tab" onclick="showTab('error-lookup')">Error Lookup</div>
                <div class="tab" onclick="showTab('customer-diagnosis')">Customer Issues</div>
                <div class="tab" onclick="showTab('monitoring')">Monitoring</div>
            </div>

            <!-- Quick Check Tab -->
            <div id="quick-check" class="tab-content active">
                <div class="section quick-check">
                    <h2>üöÄ Quick Health Check</h2>
                    <div class="form-group">
                        <label>API Key:</label>
                        <input type="password" id="apiKey" placeholder="Enter your Together AI API key">
                        <small style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-top: 5px; display: block;">
                            Get your API key from <a href="https://api.together.ai/settings/api-keys" target="_blank" style="color: #fff; text-decoration: underline;">api.together.ai/settings/api-keys</a>
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Models to Test (comma-separated):</label>
                        <input type="text" id="modelsToTest" placeholder="Leave empty for defaults" 
                               value="mistralai/Mistral-7B-Instruct-v0.1, meta-llama/Llama-2-7b-chat-hf">
                    </div>
                    <button class="btn" onclick="runQuickCheck()">Run Full Diagnostic</button>
                    <button class="btn btn-secondary" onclick="testConnectivity()">Test Connectivity Only</button>
                </div>

                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p>Running diagnostics...</p>
                </div>

                <div class="results" id="results" style="display: none;">
                    <h3>Diagnostic Results</h3>
                    <div id="resultsContent"></div>
                </div>
            </div>

            <!-- Error Lookup Tab -->
            <div id="error-lookup" class="tab-content">
                <div class="section">
                    <h2>üîç Error Code Reference</h2>
                    <p>Quick reference for common Together AI error codes and solutions:</p>
                    
                    <div class="error-lookup">
                        <div class="error-card">
                            <div class="error-code">400 - Bad Request</div>
                            <p><strong>Common Causes:</strong></p>
                            <ul>
                                <li>Invalid request format</li>
                                <li>Missing required parameters</li>
                                <li>Invalid model name</li>
                                <li>max_tokens exceeds limit</li>
                            </ul>
                            <div class="recommendation">
                                <div class="recommendation-title">Solutions:</div>
                                Validate request payload, check model name, reduce max_tokens parameter
                            </div>
                        </div>

                        <div class="error-card">
                            <div class="error-code">401 - Unauthorized</div>
                            <p><strong>Common Causes:</strong></p>
                            <ul>
                                <li>Invalid API key</li>
                                <li>Missing Authorization header</li>
                                <li>Expired credentials</li>
                            </ul>
                            <div class="recommendation">
                                <div class="recommendation-title">Solutions:</div>
                                Verify API key at api.together.ai, check header format: "Authorization: Bearer YOUR_KEY"
                            </div>
                        </div>

                        <div class="error-card">
                            <div class="error-code">429 - Rate Limit</div>
                            <p><strong>Common Causes:</strong></p>
                            <ul>
                                <li>Too many requests per second</li>
                                <li>Exceeded tokens per second</li>
                                <li>Burst traffic patterns</li>
                            </ul>
                            <div class="recommendation">
                                <div class="recommendation-title">Solutions:</div>
                                Implement exponential backoff, request higher limits, upgrade tier
                            </div>
                        </div>

                        <div class="error-card">
                            <div class="error-code">503 - Service Unavailable</div>
                            <p><strong>Common Causes:</strong></p>
                            <ul>
                                <li>Server overload</li>
                                <li>Maintenance</li>
                                <li>Capacity issues</li>
                            </ul>
                            <div class="recommendation">
                                <div class="recommendation-title">Solutions:</div>
                                Check status.together.ai, implement retry logic, consider dedicated instances
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Diagnosis Tab -->
            <div id="customer-diagnosis" class="tab-content">
                <div class="section">
                    <h2>üéØ Customer Issue Diagnosis</h2>
                    <div class="form-group">
                        <label>Describe the customer's issue:</label>
                        <textarea id="customerIssue" rows="4" 
                                  placeholder="Example: Customer reports high rate of 503 errors during peak hours..."></textarea>
                    </div>
                    <button class="btn" onclick="diagnoseCustomerIssue()">Analyze Issue</button>
                    
                    <div id="diagnosisResult" style="display: none; margin-top: 20px;">
                        <h3>Diagnosis & Recommendations</h3>
                        <div id="diagnosisContent"></div>
                    </div>
                </div>

                <div class="section">
                    <h2>üìã Common Issue Patterns</h2>
                    <div class="diagnostic-grid">
                        <div class="diagnostic-card" onclick="showIssuePattern('503-errors')">
                            <div class="card-icon">üö®</div>
                            <h3>High 503 Errors</h3>
                            <p>Service unavailable issues</p>
                        </div>
                        <div class="diagnostic-card" onclick="showIssuePattern('rate-limits')">
                            <div class="card-icon">‚è±Ô∏è</div>
                            <h3>Rate Limiting</h3>
                            <p>429 errors and throttling</p>
                        </div>
                        <div class="diagnostic-card" onclick="showIssuePattern('slow-performance')">
                            <div class="card-icon">üêå</div>
                            <h3>Slow Performance</h3>
                            <p>High latency issues</p>
                        </div>
                        <div class="diagnostic-card" onclick="showIssuePattern('auth-failures')">
                            <div class="card-icon">üîí</div>
                            <h3>Authentication</h3>
                            <p>401 auth failures</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monitoring Tab -->
            <div id="monitoring" class="tab-content">
                <div class="section">
                    <h2>üìä Monitoring Recommendations</h2>
                    
                    <h3>Essential Metrics to Track:</h3>
                    <ul>
                        <li>Request success rate (%)</li>
                        <li>Average response time (ms)</li>
                        <li>Rate limit utilization (%)</li>
                        <li>Error rate by status code</li>
                        <li>Token usage per time period</li>
                    </ul>

                    <h3>Alerting Thresholds:</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                            <strong>Error Rate</strong><br>
                            Warning: >5%<br>
                            Critical: >10%
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                            <strong>Response Time</strong><br>
                            Warning: >5s<br>
                            Critical: >10s
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                            <strong>Rate Limit Usage</strong><br>
                            Warning: >80%<br>
                            Critical: >95%
                        </div>
                    </div>

                    <h3>Quick Status Checks:</h3>
                    <button class="btn" onclick="checkTogetherStatus()">Check Together AI Status</button>
                    <button class="btn btn-secondary" onclick="testModelsList()">Test Models Endpoint</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            if (show) {
                loading.style.display = 'block';
                results.style.display = 'none';
            } else {
                loading.style.display = 'none';
                results.style.display = 'block';
            }
        }

        function showResults(results) {
            const resultsContent = document.getElementById('resultsContent');
            let html = '';
            
            results.forEach(result => {
                const statusClass = `result-${result.status.toLowerCase()}`;
                const badgeClass = `status-${result.status.toLowerCase()}`;
                
                html += `
                    <div class="${statusClass} result-item">
                        <span class="status-badge ${badgeClass}">${result.status}</span>
                        <strong>${result.test}:</strong> ${result.message}
                        ${result.recommendation ? `<div class="recommendation"><div class="recommendation-title">Recommendation:</div>${result.recommendation}</div>` : ''}
                    </div>
                `;
            });
            
            resultsContent.innerHTML = html;
            showLoading(false);
        }

        async function testConnectivity() {
            let apiKey = document.getElementById('apiKey').value.trim();
            
            // If no API key provided, try to get from environment (this won't work in browser, but shows the logic)
            if (!apiKey) {
                alert('Please enter your API key in the input field above');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch('/api/models', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                const results = [{
                    test: 'API Connectivity',
                    status: response.ok ? 'PASS' : 'FAIL',
                    message: response.ok ? 
                        `Successfully connected (Status: ${response.status})` : 
                        `Connection failed (Status: ${response.status})`,
                    recommendation: response.ok ? '' : 'Check your API key and network connection'
                }];
                
                showResults(results);
            } catch (error) {
                showResults([{
                    test: 'API Connectivity',
                    status: 'FAIL',
                    message: `Connection error: ${error.message}`,
                    recommendation: 'Check your internet connection and firewall settings'
                }]);
            }
        }

        async function runQuickCheck() {
            let apiKey = document.getElementById('apiKey').value.trim();
            const modelsInput = document.getElementById('modelsToTest').value;
            
            // If no API key provided, prompt user to enter it
            if (!apiKey) {
                alert('Please enter your Together AI API key in the input field above');
                return;
            }
            
            showLoading(true);
            
            const models = modelsInput ? 
                modelsInput.split(',').map(m => m.trim()) : 
                ['mistralai/Mistral-7B-Instruct-v0.1'];
            
            const results = [];
            
            // Test 1: Connectivity
            try {
                const modelsResponse = await fetch('/api/models', {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                
                if (modelsResponse.ok) {
                    results.push({
                        test: 'API Connectivity',
                        status: 'PASS',
                        message: 'Successfully connected to Together AI API',
                        recommendation: ''
                    });
                    
                    // Test 2: Model availability
                    const availableModels = await modelsResponse.json();
                    const modelIds = availableModels.map(m => m.id);
                    
                    for (const model of models) {
                        if (modelIds.includes(model)) {
                            results.push({
                                test: `Model: ${model}`,
                                status: 'PASS',
                                message: 'Model is available',
                                recommendation: ''
                            });
                        } else {
                            results.push({
                                test: `Model: ${model}`,
                                status: 'FAIL',
                                message: 'Model not found',
                                recommendation: 'Check model name or availability in your tier'
                            });
                        }
                    }
                    
                    // Test 3: Simple inference test
                    const workingModels = models.filter(m => modelIds.includes(m));
                    if (workingModels.length > 0) {
                        try {
                            const startTime = Date.now();
                            const inferenceResponse = await fetch('/api/inference', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${apiKey}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    model: workingModels[0],
                                    prompt: 'Hello',
                                    max_tokens: 1,
                                    temperature: 0.1
                                })
                            });
                            
                            const responseTime = Date.now() - startTime;
                            
                            if (inferenceResponse.ok) {
                                let status = 'PASS';
                                let recommendation = '';
                                
                                if (responseTime > 10000) {
                                    status = 'WARNING';
                                    recommendation = 'Response time is high - consider using smaller models';
                                }
                                
                                results.push({
                                    test: 'Inference Performance',
                                    status: status,
                                    message: `Test inference completed in ${responseTime}ms`,
                                    recommendation: recommendation
                                });
                            } else if (inferenceResponse.status === 429) {
                                results.push({
                                    test: 'Rate Limits',
                                    status: 'FAIL',
                                    message: 'Rate limit exceeded (429 error)',
                                    recommendation: 'Implement exponential backoff or request higher limits'
                                });
                            } else {
                                results.push({
                                    test: 'Inference Test',
                                    status: 'FAIL',
                                    message: `Inference failed with status ${inferenceResponse.status}`,
                                    recommendation: 'Check API documentation for error details'
                                });
                            }
                        } catch (error) {
                            results.push({
                                test: 'Inference Test',
                                status: 'FAIL',
                                message: `Inference error: ${error.message}`,
                                recommendation: 'Check network connectivity and API status'
                            });
                        }
                    }
                    
                } else if (modelsResponse.status === 401) {
                    results.push({
                        test: 'API Authentication',
                        status: 'FAIL',
                        message: 'Authentication failed - Invalid API key',
                        recommendation: 'Check your API key at api.together.ai Settings > API Keys'
                    });
                } else {
                    results.push({
                        test: 'API Connectivity',
                        status: 'FAIL',
                        message: `API request failed with status ${modelsResponse.status}`,
                        recommendation: 'Check Together AI status page at status.together.ai'
                    });
                }
                
            } catch (error) {
                results.push({
                    test: 'API Connectivity',
                    status: 'FAIL',
                    message: `Connection error: ${error.message}`,
                    recommendation: 'Check your internet connection and firewall settings'
                });
            }
            
            showResults(results);
        }

        function diagnoseCustomerIssue() {
            const issue = document.getElementById('customerIssue').value.toLowerCase();
            const diagnosisResult = document.getElementById('diagnosisResult');
            const diagnosisContent = document.getElementById('diagnosisContent');
            
            if (!issue) {
                alert('Please describe the customer issue');
                return;
            }
            
            let diagnosis = '';
            
            if (issue.includes('503')) {
                diagnosis = `
                    <div class="result-fail result-item">
                        <h4>503 Service Unavailable - Capacity/Availability Issue</h4>
                        <p><strong>Possible Causes:</strong></p>
                        <ul>
                            <li>Together AI servers are temporarily overloaded</li>
                            <li>Scheduled maintenance or capacity issues</li>
                            <li>Regional outages or network problems</li>
                        </ul>
                        <div class="recommendation">
                            <div class="recommendation-title">Recommended Actions:</div>
                            <ol>
                                <li>Check status.together.ai for known issues</li>
                                <li>Implement retry logic with exponential backoff</li>
                                <li>Consider switching to dedicated instances for guaranteed capacity</li>
                                <li>If persistent, contact Together AI support</li>
                            </ol>
                        </div>
                    </div>
                `;
            } else if (issue.includes('429') || issue.includes('rate limit')) {
                diagnosis = `
                    <div class="result-warning result-item">
                        <h4>429 Rate Limit Exceeded - Traffic Management Issue</h4>
                        <p><strong>Possible Causes:</strong></p>
                        <ul>
                            <li>Exceeding requests per second (RPS) limits</li>
                            <li>Exceeding tokens per second (TPS) limits</li>
                            <li>Burst traffic patterns overwhelming limits</li>
                        </ul>
                        <div class="recommendation">
                            <div class="recommendation-title">Recommended Actions:</div>
                            <ol>
                                <li>Implement request queuing and rate limiting</li>
                                <li>Use exponential backoff for retries</li>
                                <li>Monitor rate limit headers in responses</li>
                                <li>Request higher limits at together.ai/forms/rate-limit-increase</li>
                                <li>Consider upgrading to Scale or Enterprise tiers</li>
                            </ol>
                        </div>
                    </div>
                `;
            } else if (issue.includes('401') || issue.includes('authentication')) {
                diagnosis = `
                    <div class="result-fail result-item">
                        <h4>401 Authentication Failed - Credential Issue</h4>
                        <p><strong>Possible Causes:</strong></p>
                        <ul>
                            <li>Invalid or expired API key</li>
                            <li>API key not included in Authorization header</li>
                            <li>Incorrect header format</li>
                        </ul>
                        <div class="recommendation">
                            <div class="recommendation-title">Recommended Actions:</div>
                            <ol>
                                <li>Verify API key at api.together.ai Settings > API Keys</li>
                                <li>Ensure header format: "Authorization: Bearer YOUR_API_KEY"</li>
                                <li>Regenerate API key if compromised</li>
                                <li>Check if API key has required permissions</li>
                            </ol>
                        </div>
                    </div>
                `;
            } else if (issue.includes('timeout') || issue.includes('slow')) {
                diagnosis = `
                    <div class="result-warning result-item">
                        <h4>Performance/Timeout Issues - Latency Problem</h4>
                        <p><strong>Possible Causes:</strong></p>
                        <ul>
                            <li>Large models taking longer to generate responses</li>
                            <li>High system load during peak hours</li>
                            <li>Complex prompts requiring more processing</li>
                            <li>Network latency issues</li>
                        </ul>
                        <div class="recommendation">
                            <div class="recommendation-title">Recommended Actions:</div>
                            <ol>
                                <li>Increase client timeout values</li>
                                <li>Use smaller/faster models for time-critical applications</li>
                                <li>Implement async processing for long requests</li>
                                <li>Consider dedicated instances for consistent performance</li>
                                <li>Optimize prompts to be more specific and concise</li>
                            </ol>
                        </div>
                    </div>
                `;
            } else {
                diagnosis = `
                    <div class="result-info result-item">
                        <h4>General Troubleshooting Steps</h4>
                        <div class="recommendation">
                            <div class="recommendation-title">Recommended Actions:</div>
                            <ol>
                                <li>Run full diagnostic using the Quick Check tab</li>
                                <li>Check Together AI status page at status.together.ai</li>
                                <li>Verify API key and permissions</li>
                                <li>Test with different models and simple prompts</li>
                                <li>Implement proper error handling and retries</li>
                                <li>Monitor rate limits and usage patterns</li>
                                <li>Contact Together AI support with specific error details</li>
                            </ol>
                        </div>
                    </div>
                `;
            }
            
            diagnosisContent.innerHTML = diagnosis;
            diagnosisResult.style.display = 'block';
        }

        function showIssuePattern(pattern) {
            const patterns = {
                '503-errors': {
                    title: 'High 503 Error Rate Pattern',
                    content: `
                        <h4>Investigation Steps:</h4>
                        <ul>
                            <li>Check Together AI status page for incidents</li>
                            <li>Review customer's request patterns for traffic spikes</li>
                            <li>Verify if customer is on appropriate tier for their usage</li>
                            <li>Check if specific models are experiencing issues</li>
                        </ul>
                        <h4>Solutions:</h4>
                        <ul>
                            <li>Implement exponential backoff with jitter</li>
                            <li>Add circuit breaker pattern</li>
                            <li>Recommend dedicated instances for guaranteed capacity</li>
                            <li>Suggest load balancing across multiple models</li>
                        </ul>
                    `
                },
                'rate-limits': {
                    title: 'Rate Limiting Issues Pattern',
                    content: `
                        <h4>Investigation Steps:</h4>
                        <ul>
                            <li>Check customer's current rate limit tier and usage</li>
                            <li>Analyze request patterns for bursts vs steady load</li>
                            <li>Review if rate limit headers are being monitored</li>
                            <li>Verify proper retry implementation</li>
                        </ul>
                        <h4>Solutions:</h4>
                        <ul>
                            <li>Implement request queuing to smooth traffic</li>
                            <li>Add rate limit monitoring and alerting</li>
                            <li>Request rate limit increase with justification</li>
                            <li>Suggest upgrading to Scale/Enterprise tier</li>
                        </ul>
                    `
                },
                'slow-performance': {
                    title: 'Performance Issues Pattern',
                    content: `
                        <h4>Investigation Steps:</h4>
                        <ul>
                            <li>Measure actual response times for customer's models</li>
                            <li>Check if customer is using appropriate model size</li>
                            <li>Review prompt complexity and length</li>
                            <li>Verify customer's geographic location vs server regions</li>
                        </ul>
                        <h4>Solutions:</h4>
                        <ul>
                            <li>Recommend smaller/faster models for latency-sensitive use cases</li>
                            <li>Suggest prompt optimization techniques</li>
                            <li>Consider dedicated instances for consistent performance</li>
                            <li>Implement async processing for long-running requests</li>
                        </ul>
                    `
                },
                'auth-failures': {
                    title: 'Authentication Failures Pattern',
                    content: `
                        <h4>Investigation Steps:</h4>
                        <ul>
                            <li>Verify API key format and validity</li>
                            <li>Check if API key was recently regenerated</li>
                            <li>Review Authorization header implementation</li>
                            <li>Test with known working API key</li>
                        </ul>
                        <h4>Solutions:</h4>
                        <ul>
                            <li>Guide through API key regeneration process</li>
                            <li>Provide correct header format examples</li>
                            <li>Check account status and billing</li>
                            <li>Verify API permissions and scope</li>
                        </ul>
                    `
                }
            };
            
            const pattern_info = patterns[pattern];
            if (pattern_info) {
                const diagnosisResult = document.getElementById('diagnosisResult');
                const diagnosisContent = document.getElementById('diagnosisContent');
                
                diagnosisContent.innerHTML = `
                    <div class="result-info result-item">
                        <h4>${pattern_info.title}</h4>
                        ${pattern_info.content}
                    </div>
                `;
                diagnosisResult.style.display = 'block';
            }
        }

        function checkTogetherStatus() {
            window.open('https://status.together.ai/', '_blank');
        }

        async function testModelsList() {
            let apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }
            
            try {
                showLoading(true);
                const response = await fetch('/api/models', {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                
                if (response.ok) {
                    const models = await response.json();
                    showResults([{
                        test: 'Models Endpoint',
                        status: 'PASS',
                        message: `Models endpoint accessible. Found ${models.length} available models`,
                        recommendation: ''
                    }]);
                } else {
                    showResults([{
                        test: 'Models Endpoint',
                        status: 'FAIL',
                        message: `Models endpoint failed with status ${response.status}`,
                        recommendation: 'Check Together AI service status'
                    }]);
                }
            } catch (error) {
                showResults([{
                    test: 'Models Endpoint',
                    status: 'FAIL',
                    message: `Network error: ${error.message}`,
                    recommendation: 'Check your internet connection'
                }]);
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-focus on API key input
            document.getElementById('apiKey').focus();
            
            // Add Enter key support for quick check
            document.getElementById('apiKey').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    testConnectivity();
                }
            });
        });
    </script>
</body>
</html>